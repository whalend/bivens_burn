---
title: "Bivens Experiment Fire - Analysis and Results"
author: "W.W. Dillon"
date: "10/21/2019"
output: html_document
---

```{r setup, message=FALSE, echo=F}

knitr::opts_chunk$set(echo = F, warning = F, message = F)
knitr::opts_chunk$set(fig.width = 7.5, )


## load packages ####

library(plyr)
library(dplyr)
library(tidyr)
library(readxl)
library(readr)
library(ggplot2)
library(viridis)

# global values ####
figure_width <-  7.5
figure_height <- 7.5

# define color ####
# invasion_color <- scale_color_viridis(begin = .15, end = .9, option = "E", discrete = T)
# invasion_fill <- scale_fill_viridis(begin = .15, end = .9, option = "E", discrete = T)

invasion_color <- scale_color_manual(values = c("Reference" ="deepskyblue", "Invaded"="red"))
invasion_fill <- scale_fill_manual(values = c("Reference" ="deepskyblue", "Invaded"="red"))

# define theme ####
def_theme <- theme(legend.title = element_blank(),
            legend.text = element_text(size = 14),
            # legend.position = "none",
            axis.text = element_text(size = 18, color = "black"),
            axis.title = element_text(size = 18),
            plot.title = element_text(size = 20),
            # strip.background = element_blank(),
            strip.text = element_text(size = 14),
            panel.grid = element_blank()
            )

dodge <- position_dodge(width=0.9)

```

# RESULTS Most Relevant to Manuscript


```{r add scaled variables for modeling}

# write_csv(tree_agg_plot_data,"data/tree_mortality_model_data.csv")

## Read-in data if needed
# tree_agg_plot_data <- read_csv("data/tree_mortality_model_data.csv")

## Rescale variables
### Continuous: center and divide by 2 standard deviations, 'scl'
model_data <- tree_agg_plot_data %>% 
  # mutate(tree_id = paste(Plot, ))
  group_by(probe_ht) %>%
  # ungroup(.) %>%
  # filter(probe_ht=="50cm") %>% 
  # select(survival, avg_max_temp:avg_flameht_cm, char_ht_cm, ht2_cm, veg_trt, water_trt, Plot, tree_id, Ind.) %>% 
  mutate(
    max_temp_scl = (avg_max_temp-mean(avg_max_temp))/(2*sd(avg_max_temp)),
    maxt_scale = scale(avg_max_temp),
    
    s_abv100_scl = (avg_s_abv_100-mean(avg_s_abv_100))/(2*sd(avg_s_abv_100)),
    sabv100_scale = scale(avg_s_abv_100),
         
    heat_flux_scl = (avg_heat_flux100-mean(avg_heat_flux100))/(2*sd(avg_heat_flux100)),
    hflux_scale = scale(avg_heat_flux100),
    
    dry_wt_scl = (avg_dry_wt-mean(avg_dry_wt))/(2*sd(avg_dry_wt)),
    wt_scale = scale(avg_dry_wt),
    
    fuel_ht_scl = (avg_fuel_ht_cm-mean(avg_fuel_ht_cm))/(2*sd(avg_fuel_ht_cm)),
    fuelht_scale = scale(avg_fuel_ht_cm),
    
    tree_ht_scl =  (ht2_cm-mean(ht2_cm))/(2*sd(ht2_cm)),
    treeht_scale = scale(ht2_cm),
    
    flame_ht_scl =  (avg_flameht_cm-mean(avg_flameht_cm))/(2*sd(avg_flameht_cm)),
    flameht_scale = scale(avg_flameht_cm),
    
    char_ht_scl = (char_ht_cm-mean(char_ht_cm))/(2*sd(char_ht_cm)),
    charht_scale = scale(char_ht_cm),
    
    veg_trt = factor(veg_trt, levels = c("Reference", "Invaded")),
    
    veg_trt_code = recode_factor(veg_trt, "Reference" = 0, "Invaded" = 1),
    water_trt_code = recode_factor(water_trt, "Ambient" = 0 , "Drought" = 1)
    
         ) %>% 
  ungroup(.) %>% 
  mutate(Plot = as.factor(Plot),
         tree_id = paste(Plot, Ind., sep = ""))
# summary(model_data)

dat0cm <- droplevels(filter(model_data, probe_ht=="0cm"))
dat25cm <- droplevels(filter(model_data, probe_ht=="25cm"))
dat50cm <- droplevels(filter(model_data, probe_ht=="50cm"))

# summary(select(dat0cm, tree_ht_scl, heat_flux_scl, flame_ht_scl))
# summary(select(dat25cm, tree_ht_scl, heat_flux_scl, flame_ht_scl))
# summary(select(dat50cm, tree_ht_scl, heat_flux_scl, flame_ht_scl))

```

## Tree Plot Level Response Models
These models and figures use only data from plots that had trees in them at the time of the fires (n=32).

```{r tree plots data}
tree_plots_dat <- filter(agg_plot_data, Plot %in% unique(dat25cm$Plot))

## 32 unique plots, temperature values from 3 probe height levels
# n_distinct(tree_plots_dat$Plot)
```

### Tree Height Model

Illustrate the effect of treatments (drought and invasion) on tree heights.

```{r model tree height}

library(lme4)
library(sjPlot)

(tree_ht_boxplot <- ggplot(dat25cm, 
       aes(water_trt, ht2_cm)) +
  geom_boxplot(aes(fill = veg_trt), alpha = 0, show.legend = FALSE) +
  geom_point(aes(color = veg_trt, shape = water_trt), position = position_jitterdodge(dodge.width = .75), alpha = 1, size = 4) +
  scale_shape_discrete(solid = FALSE) +
  invasion_fill +
  invasion_color +
  theme_classic() +
  def_theme +
  xlab("") +
  ylab("Tree height (cm)") +
  theme(legend.position = "none",
        legend.title = element_blank(),
        legend.text = element_text(size = 12))
)

ggsave("figures/treeht_trt_boxplot.pdf", width = 7, height = 7, dpi = 600)

knitr::kable(dat25cm %>% 
         group_by(veg_trt, water_trt) %>% 
         summarise(nobs = length(ht2_cm),
                   avg_ht = mean(ht2_cm),
                   sd = sd(ht2_cm, na.rm = T)),
         digits = 1, caption = "Average tree height")


tree_ht_mod <- lmer(ht2_cm ~ water_trt*veg_trt + (1|Plot), data = dat25cm)
# plot_model(tree_ht_mod, type = "diag")
summary(tree_ht_mod)

broom::tidy(tree_ht_mod) %>% 
  knitr::kable(., caption = "Tree height model results")

tree_ht_mod_coefs <- plot_model(tree_ht_mod, show.values = T, color = "bw", 
                                value.size = 6)
tree_ht_mod_coefs$data$term <- c("Drought","Invaded","Invaded X Drought")

tree_ht_mod_coefs +
  theme_classic() +
  geom_hline(yintercept = 0, color = "grey90") +
  ggtitle("") +
  ylab("Est. effect on tree height (cm)") +
  def_theme +
  theme(axis.text = element_text(color = "black")) +
  NULL

# plot_model(tree_ht_mod, type = "int", pred.type = "re") +
#   invasion_color +
#   theme_classic() +
#   ggtitle("") +
#   ylab("Tree height (cm)") +
#   xlab("Ambient - Drought") +
#   def_theme +
#   NULL

ggsave("figures/treeht_coef.pdf", height = 7, width = 7, dpi = 600)
# PNAS recommended max height: 54 picas / 9” / 22.5 cm. 
# Use one of the following widths: 
# 1 column wide (20.5 picas / 3.42” / 8.7 cm) 
# 1.5 columns wide (27 picas / 4.5” / 11.4 cm) 
# 2 columns wide (42.125 picas / 7” / 17.8 cm)


MuMIn::r.squaredGLMM(tree_ht_mod)# plot random effect increase R2 over 2x

```

### Fuel Loads

Illustrate effects of treatments (drought and invasion) on fuel loads.

```{r fuel loads figure}

(fuel_loads_boxplot <- tree_plots_dat %>% filter(probe_ht=="25cm") %>%
  ggplot(aes(water_trt, .001*avg_dry_wt*16)) +
  geom_boxplot(aes(color = veg_trt), alpha = .2, show.legend = FALSE, outlier.shape = NA) +
  geom_point(aes(color = veg_trt, shape = water_trt), position = position_jitterdodge(dodge.width = .75), alpha = 1, size = 4) +
  scale_shape_discrete(solid = FALSE) +
  scale_y_continuous(limits = c(0,2)) +
  invasion_fill +
  invasion_color +
  theme_classic() +
  def_theme +
  xlab("") +
  ylab(expression(paste("Fuel load (kg ", {m}^-2, ")"), sep = "")) +
  theme(legend.position = c(.15, .9),
        legend.margin = margin(-8,-1,-8,-1))
)

ggsave("figures/fuel_load_trt_boxplot.pdf", width = 7, height = 7, dpi = 600)

```

```{r fuel load table ms}

knitr::kable(tree_plots_dat %>% filter(probe_ht=="25cm") %>% 
    group_by(water_trt, veg_trt) %>% 
    summarise(avg_drywt_kg_m2 = mean(.001*avg_dry_wt*16),
              nobs = length(avg_dry_wt),
              se_drywt_kg = sd(.001*avg_dry_wt*16)/sqrt(nobs)) %>% 
      select(-nobs),
    digits = 2, caption = "Average fuel loads by treatment from sample dry weights (kg/m2)")

```

```{r fuel load model ms}

fuel_load_model <- lm(avg_dry_wt ~ veg_trt + water_trt, 
                      data = tree_plots_dat %>% filter(probe_ht=="25cm"))
summary(fuel_load_model)

broom::tidy(fuel_load_model) %>% 
  knitr::kable(., caption = "Fuel load model results", digits = 2)

```

### Fuel moisture

```{r fuel moisture fig}

(fuel_moisture_boxplot <- tree_plots_dat %>% filter(probe_ht=="25cm") %>%
  ggplot(aes(water_trt, avg_fuel_moisture)) +
  geom_boxplot(aes(color = veg_trt), alpha = 0, show.legend = FALSE) +
  geom_point(aes(color = veg_trt, shape = water_trt), position = position_jitterdodge(dodge.width = .75), alpha = 1, size = 4) +
  scale_shape_discrete(solid = FALSE) +
  scale_y_continuous(limits = c(0,NA))+
  invasion_fill +
  invasion_color +
  theme_classic() +
  def_theme +
  xlab("") +
  ylab("Fuel moisture (%)") +
  theme(legend.position = "none")
)

ggsave("figures/fuel_moisture_trt_boxplot.pdf", width = 7, height = 7, dpi = 600)

```

```{r fuel moisture model}

fuel_moisture_model <- lm(avg_fuel_moisture ~ veg_trt + water_trt, 
                      data = tree_plots_dat %>% filter(probe_ht=="25cm"))
summary(fuel_moisture_model)

broom::tidy(fuel_moisture_model) %>% 
  knitr::kable(., caption = "Fuel moisture model results", digits = 2)

```

### Fuel height

```{r fuel height fig}

(fuel_height_boxplot <- tree_plots_dat %>% filter(probe_ht=="25cm") %>%
  ggplot(aes(water_trt, avg_fuel_ht_cm)) +
  geom_boxplot(aes(color = veg_trt), alpha = 0, show.legend = FALSE) +
  geom_point(aes(color = veg_trt, shape = water_trt), position = position_jitterdodge(dodge.width = .75), alpha = 1, size = 4) +
  scale_shape_discrete(solid = FALSE) +
  scale_y_continuous(limits = c(0,NA)) +
  invasion_fill +
  invasion_color +
  theme_classic() +
  def_theme +
  xlab("") +
  ylab("Fuel height (cm)") +
  theme(legend.position = "none")
)

ggsave("figures/fuelht_trt_boxplot.pdf", width = 7, height = 7, dpi = 600)

```

```{r fuel height model}

fuel_height_model <- lm(avg_fuel_ht_cm ~ veg_trt*water_trt, 
                      data = tree_plots_dat %>% filter(probe_ht=="25cm"))
summary(fuel_height_model)
car::Anova(fuel_height_model, type = "II")

broom::tidy(fuel_height_model) %>% 
  knitr::kable(., caption = "Fuel height model results", digits = 2)

```

### Fuel load & moisture figure

```{r fuel load height moisture fig}

cowplot::plot_grid(
  fuel_loads_boxplot +
    theme(legend.position = c(.15, .85)),
  fuel_height_boxplot +
    theme(legend.position = "none"),
  fuel_moisture_boxplot +
    theme(legend.position = "none"),
  ncol = 1, labels = "AUTO"
)

ggsave("figures/fl_fh_fm_fig_600dpi.pdf",
       height = 14, width = 6, dpi = 600)

```


### Flame height 

Regression model of fuel load and treaments on estimated flame heights. Flame heights were taller in invaded plots. There was no differenct in flame height between ambient and drought plots.

```{r flame height model}

## filter to a single probe height so we don't have pseudo-replication
flame_ht_mod <- lm(avg_flameht_cm ~ avg_dry_wt + veg_trt, data = filter(tree_plots_dat, probe_ht == "25cm") %>% 
                     mutate(avg_dry_wt = (avg_dry_wt*16)/1000))
## tested avg fuel height to no effect
# plot_model(flame_ht_mod, type = "diag")
# summary(flame_ht_mod)

# flame_ht_mod2 <- lm(avg_flameht_cm ~ avg_fuel_ht_cm + veg_trt, data = filter(tree_plots_dat, probe_ht == "25cm"))
# summary(flame_ht_mod2)

### ###
## Fuel height does not add explanatory power to the model; veg_trt alone (greater flame heights in invaded) explains 80% of the variation in flame height. Fuel load adds about 5% more variation explained
### ###

# plot_model(flame_ht_mod, type = "pred", terms = c("avg_dry_wt", "veg_trt"), show.data = T) +
#   invasion_color +
#   invasion_fill +
#   ggtitle("")

broom::tidy(flame_ht_mod) %>% 
  knitr::kable(., caption = "Flame height model results")
(fh_mod_summary <- summary(flame_ht_mod))
fh_mod_summary$r.squared

```

```{r flame ht fuel load fig}

fht_mod_pred <- sjPlot::plot_model(flame_ht_mod, type = "pred", terms = c("avg_dry_wt","veg_trt"))
  
ggplot() +
  geom_ribbon(data = fht_mod_pred$data, 
              aes(x = x, ymin = conf.low, ymax = conf.high, fill = group), alpha = .2, show.legend = FALSE) +
  geom_line(data = fht_mod_pred$data, 
            aes(x = x, y = predicted, color = group), show.legend = FALSE) +
  geom_point(data = filter(tree_plots_dat, probe_ht == "25cm"),
             aes(x = (avg_dry_wt*16)/1000, y = avg_flameht_cm,
                 color = veg_trt, shape = water_trt), alpha = 1, size = 4) +
  scale_shape_discrete(solid = FALSE) +
  invasion_color +
  invasion_fill +
  
  scale_x_continuous(limits = c(NA, 2)) +
  theme_classic() +
  def_theme +
  theme(legend.position = c(.11,.9),
        legend.margin = margin(-8,-1,-8,-1),
        legend.direction = "vertical",
        legend.background = element_blank()) +
  xlab(expression(paste("Fuel load (kg ", {m}^-2, ")"), sep = "")) +
  ylab("Flame height (cm)") +
  NULL

ggsave("figures/fh_fig_7x7_600dpi.png",
       height = 7, width = 7, units = "in", dpi = 600)
# PNAS recommended max height: 54 picas / 9” / 22.5 cm. 
# Use one of the following widths: 
# 1 column wide (20.5 picas / 3.42” / 8.7 cm) 
# 1.5 columns wide (27 picas / 4.5” / 11.4 cm) 
# 2 columns wide (42.125 picas / 7” / 17.8 cm)


```


### Temperatures

```{r max temp models}
# separate temperature models for each probe height (0 cm, 25 cm, 50 cm)

maxtemp <- lm(avg_max_temp ~ avg_dry_wt + avg_fuel_ht_cm + probe_ht*veg_trt, data = tree_plots_dat)
summary(maxtemp)
car::vif(maxtemp)
broom::tidy(maxtemp) %>% 
  knitr::kable(.)

maxtemp0cm <- lm(avg_max_temp ~ avg_dry_wt + veg_trt, data = filter(tree_plots_dat, probe_ht == "0cm") %>% 
                   mutate(avg_dry_wt = (avg_dry_wt*16)/1000))
summary(maxtemp0cm)
sjPlot::plot_model(maxtemp0cm, type = "pred", terms = c("avg_dry_wt","veg_trt"), show.data = TRUE) + invasion_color + invasion_fill

maxtemp25cm <- lm(avg_max_temp ~ avg_dry_wt + veg_trt, data = filter(tree_plots_dat, probe_ht == "25cm") %>% 
                   mutate(avg_dry_wt = (avg_dry_wt*16)/1000))
summary(maxtemp25cm)
# plot_model(maxtemp25cm, type = "diag")

maxtemp50cm <- lm(avg_max_temp ~ avg_dry_wt + veg_trt, data = filter(tree_plots_dat, probe_ht == "50cm")%>% 
                   mutate(avg_dry_wt = (avg_dry_wt*16)/1000))
summary(maxtemp50cm)



maxtemp_pred_data <- rbind(
  ggeffects::ggpredict(maxtemp0cm, terms = c("avg_dry_wt","veg_trt")) %>% 
    mutate(location = "0 cm"),
  ggeffects::ggpredict(maxtemp25cm, terms = c("avg_dry_wt","veg_trt")) %>% 
    mutate(location = "25 cm"),
  ggeffects::ggpredict(maxtemp50cm, terms = c("avg_dry_wt","veg_trt")) %>% 
    mutate(location = "50 cm")
) %>% 
  mutate(location = factor(location, levels = c("50 cm","25 cm", "0 cm")))

```




```{r s abv 100 models}

sabv100 <- lm(avg_s_abv_100 ~ scale(avg_dry_wt) + scale(avg_fuel_ht_cm) + probe_ht*veg_trt, data = tree_plots_dat)
summary(sabv100)
car::vif(sabv100)
broom::tidy(sabv100) %>% 
  knitr::kable(.)

sabv100_50cm <- lm(avg_s_abv_100 ~ avg_dry_wt + veg_trt + avg_fuel_ht_cm, data = filter(tree_plots_dat, probe_ht == "50cm")%>% 
                   mutate(avg_dry_wt = (avg_dry_wt*16)/1000))
summary(sabv100_50cm)
sjPlot::plot_model(sabv100_50cm, type = "diag")
sjPlot::plot_model(sabv100_50cm, type = "pred", terms = c("avg_dry_wt","veg_trt","avg_fuel_ht_cm"), show.data = TRUE) +
  invasion_color + invasion_fill

sabv100_25cm <- lm(avg_s_abv_100 ~ avg_dry_wt + veg_trt + avg_fuel_ht_cm, data = filter(tree_plots_dat, probe_ht == "25cm") %>% 
                   mutate(avg_dry_wt = (avg_dry_wt*16)/1000))
summary(sabv100_25cm)
sjPlot::plot_model(sabv100_25cm, type = "diag")
sjPlot::plot_model(sabv100_25cm, type = "pred", terms = c("avg_dry_wt","veg_trt","avg_fuel_ht_cm"), show.data = TRUE) +
  invasion_color + invasion_fill


sabv100_0cm <- lm(avg_s_abv_100 ~ avg_dry_wt + veg_trt + avg_fuel_ht_cm, data = filter(tree_plots_dat, probe_ht == "0cm") %>% 
                   mutate(avg_dry_wt = (avg_dry_wt*16)/1000))
summary(sabv100_0cm)
sjPlot::plot_model(sabv100_0cm, type = "diag")
sjPlot::plot_model(sabv100_0cm, type = "pred", terms = c("avg_dry_wt","veg_trt","avg_fuel_ht_cm"), show.data = TRUE) +
  invasion_color + invasion_fill



## Predictions adjusted for average fuel height of 31.85 cm
sabv_pred_data <- rbind(
  ggeffects::ggpredict(sabv100_0cm, terms = c("avg_dry_wt","veg_trt")) %>% 
    mutate(location = "0 cm"),
  ggeffects::ggpredict(sabv100_25cm, terms = c("avg_dry_wt","veg_trt")) %>% 
    mutate(location = "25 cm"),
  ggeffects::ggpredict(sabv100_50cm, terms = c("avg_dry_wt","veg_trt")) %>% 
    mutate(location = "50 cm")
) %>% 
  mutate(location = factor(location, levels = c("50 cm","25 cm", "0 cm")))


# hflux_mod <- lm(avg_heat_flux100 ~ avg_dry_wt + probe_ht + veg_trt, data = tree_plots_dat)
# summary(hflux_mod)

```


Fire temperature averages for plots with trees (n=32).

```{r temperatures figure1 ms}

# fig_labels <- data.frame(
#   probe_ht = c("50cm","25cm","0cm"), 
#   panel_id = c("A","B","C"),
#   avg_dry_wt=c(.1,.1,.1), 
#   avg_max_temp=c(1050,1050,1050))

(max_temp_pred_fig <- ggplot() +
  geom_ribbon(data = maxtemp_pred_data, 
              aes(x = x, ymin = conf.low, ymax = conf.high, fill = group),
              alpha = .2) +
  geom_line(data = maxtemp_pred_data, aes(x = x, y = conf.low, color = group), linetype = "dashed", show.legend = FALSE) +
  geom_line(data = maxtemp_pred_data, aes(x = x, y = conf.high, color = group), linetype = "dashed", show.legend = FALSE) +
  
  geom_line(data = maxtemp_pred_data, aes(x = x, y = predicted, color = group), show.legend = FALSE, size = .75) +
  
  geom_point(data = tree_plots_dat, 
             aes(x = (avg_dry_wt*16)/1000, y = avg_max_temp, 
                 color = veg_trt, shape = water_trt), 
             alpha = 1, size = 4) +
  scale_shape_discrete(solid = FALSE) +
  
  invasion_color +
  invasion_fill +
  facet_grid(location~.) +
  
  xlab(expression(paste("Fuel load (kg ", {m}^-2, ")"), sep = "")) +
  ylab("Maximum temperature (ºC)") +
  
  theme_bw() +
  def_theme +
  theme(legend.position = "none", 
        legend.direction = "vertical",
        legend.background = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(color = "white")) +
  NULL
)

ggsave("figures/maxtemp_pred.png", max_temp_pred_fig, 
       width = 3.5, height = 7, dpi = 600)


## Raw data figure of maximum temperature
# (max_temp_fig <- ggplot(tree_plots_dat, aes((avg_dry_wt*16)/1000, avg_max_temp)) +
#   geom_point(aes(color = veg_trt, shape = water_trt), alpha = 1, size = 4) +
#   scale_shape_discrete(solid = FALSE) +
#   invasion_color +
#   invasion_fill +
#   geom_smooth(aes(color = veg_trt, fill = veg_trt), alpha = .2, method = "lm", show.legend = FALSE) +
#   # geom_text(data = fig_labels, aes(label = panel_id), fontface = "bold") +
#   facet_grid(probe_ht~.) +
#     scale_x_continuous(limits = c(0,2)) +
#   theme_bw() +
#   def_theme +
#   theme(legend.position = "none", 
#         legend.direction = "vertical",
#         legend.background = element_blank()) +
#   xlab(expression(paste("Fuel load (kg ", {m}^-2, ")"), sep = "")) +
#   ylab("Maximum temperature (ºC)")
# )

## time above 100 ºC ####
# fig_labels <- data.frame(
#   probe_ht = c("50cm","25cm","0cm"), 
#   panel_id = c("D","E","F"),
#   avg_dry_wt=c(-.1,-.1,-.1), 
#   avg_s_abv_100=c(300,300,300))


(sabv_100_pred_fig <- ggplot() +
  geom_ribbon(data = sabv_pred_data, 
              aes(x = x, ymin = conf.low, ymax = conf.high, fill = group),
              alpha = .2, show.legend = FALSE) +
  geom_line(data = sabv_pred_data, aes(x = x, y = conf.low, color = group), linetype = "dashed", show.legend = FALSE) +
  geom_line(data = sabv_pred_data, aes(x = x, y = conf.high, color = group), linetype = "dashed", show.legend = FALSE) +
  
  geom_line(data = sabv_pred_data, aes(x = x, y = predicted, color = group), show.legend = FALSE, size = .75) +
  
  geom_point(data = tree_plots_dat, 
             aes(x = (avg_dry_wt*16)/1000, y = avg_s_abv_100, 
                 color = veg_trt, shape = water_trt), 
             alpha = 1, size = 4) +
  scale_shape_discrete(solid = FALSE) +
  
  invasion_color +
  invasion_fill +
  facet_grid(location~.) +
  
  xlab(expression(paste("Fuel load (kg ", {m}^-2, ")"), sep = "")) +
  ylab("Seconds >100 ºC") +
  
  theme_bw() +
  def_theme +
  theme(legend.position = "none", 
        legend.direction = "vertical",
        legend.background = element_blank(),
        legend.margin = margin(-8,-1,-8,-1)
        # strip.background = element_blank(),
        # strip.text = element_text(color = "white")
        ) +
  NULL
)

ggsave("figures/sabv_100_pred.png", sabv_100_pred_fig, 
       width = 3.5, height = 7, dpi = 600)

# ggsave("figures/sabv_100_pred_legend.png", sabv_100_pred_fig, 
       # width = 3.5, height = 7, dpi = 600)

## Raw data figure of seconds abve 100 ºC
# (time_abv_100_fig <- ggplot(tree_plots_dat, aes((avg_dry_wt*16)/1000, avg_s_abv_100)) +
#   geom_point(aes(color = veg_trt, shape = water_trt), size = 4) +
#   scale_shape_discrete(solid = FALSE) +
#   invasion_color +
#   invasion_fill +
#   geom_smooth(aes(color = veg_trt, fill = veg_trt), alpha = .2, method = "lm", show.legend = FALSE) +
#   scale_x_continuous(limits = c(0,2)) +
#   
#   # geom_text(data = fig_labels, aes(label = panel_id), fontface = "bold") +
#   
#   facet_grid(probe_ht~.) +
#   theme_bw() +
#   def_theme +
#   theme(legend.direction = "vertical",
#         legend.background = element_blank()) +
#   xlab(expression(paste("Fuel load (kg ", {m}^-2, ")"), sep = "")) +
#   ylab("Temperature residence time (s >100ºC)")
# )

cowplot::plot_grid(
  max_temp_pred_fig +
    theme(strip.background = element_blank(),
          strip.text = element_text(color = "white"),
          legend.margin = margin(t = -3, r = 0, b = -3, l = 0),
          legend.position = "none"
          ),
  
  sabv_100_pred_fig +
    theme(
          legend.margin = margin(-8,-1,-8,-1),
          # legend.position = c(.85,.9),
          legend.position = "right",
          legend.direction = "vertical"),
  rel_widths = c(1,1.3)
  )

# ggsave("figures/fire_temperatures_7x7_600dpi.png",
       # height = 7, width = 7, units = "in", dpi = 600)
# PNAS recommended max height: 54 picas / 9” / 22.5 cm. 
# Use one of the following widths: 
# 1 column wide (20.5 picas / 3.42” / 8.7 cm) 
# 1.5 columns wide (27 picas / 4.5” / 11.4 cm) 
# 2 columns wide (42.125 picas / 7” / 17.8 cm)

```


## Post-fire tree survival


```{r char height fig ms}

(char_ht_boxplot <- tree_dmg %>%
  ggplot(aes(water_trt, char_ht_cm)) +
  geom_boxplot(aes(color = veg_trt), show.legend = FALSE) +
  geom_point(aes(color = veg_trt, shape = water_trt), position = position_jitterdodge(dodge.width = .75), alpha = 1, size = 4) +
  scale_shape_discrete(solid = FALSE) +
  invasion_fill +
  invasion_color +
  theme_classic() +
  def_theme +
  xlab("") +
  ylab("Char height (cm)") +
  theme(legend.position = "top")
)

ggsave("figures/char_ht_600dpi.png", dpi = 600, width = 3.42, height = 3.42)

```

Box-plot showing the proportion of trees in each plot (n=32) that survived the fires.

```{r summarize llp survival ms}

tree_surv_plot <- tree_dmg %>% 
  group_by(Plot, water_trt, veg_trt) %>% 
  summarise(survival = sum(survival)/length(survival))

(pct_surv_boxplot <- ggplot(tree_surv_plot, aes(water_trt, survival*100)) +
  geom_boxplot(aes(color = veg_trt), alpha = 1, show.legend = FALSE, outlier.shape = NA) +
  geom_point(aes(color = veg_trt, shape = water_trt), size = 4,
             position = position_jitterdodge(dodge.width = .75)) +
  scale_shape_discrete(solid = FALSE) +
  # stat_summary(fun.data = "mean_se", geom = "pointrange", position = position_dodge(width = .5), size = 1) +
  invasion_fill +
  invasion_color +
  theme_classic() +
  def_theme +
  xlab("") +
  ylab("% Survival") +
  theme(legend.position = "none")
)

ggsave("figures/pct_survival_boxplot.pdf", width = 7, height = 7, dpi = 600)

```

Table summarizing number of plots in each treatment combination with total number of trees and the proportion of the total trees that survived in each treatment group. This table is complementary to the box-plot above.

```{r tree survival summary table ms}

tree_dmg %>% 
  group_by(water_trt, veg_trt) %>% 
  summarise(plots = n_distinct(Plot),
            trees = length(tree_id),
            dead = sum(dead),
            pct_survival = 100*sum(survival)/length(survival),
            sd_pct_survival = 100*(sd(survival, na.rm = TRUE))) %>% 
  knitr::kable(., digits = 2)

```


```{r ht load survival boxplots ms}

cowplot::plot_grid(
  pct_surv_boxplot +
    theme(legend.position = c(.15,.15),
          legend.background = element_blank(),
          # legend.box.margin = margin(-5,-1,10, 1),
          axis.text.x = element_text(colour = "white"),
          axis.text.y = element_text(colour = "black")),
  tree_ht_boxplot +
    theme(legend.position = "none",
          axis.text.x = element_text(colour = "white"),
          axis.text.y = element_text(colour = "black")),
  fuel_loads_boxplot +
    theme(legend.position = "none",
          axis.text = element_text(color = "black")),
  ncol = 1, labels = "AUTO"
)

ggsave("figures/boxplots_600dpi.png",
       height = 9, width = 4.5, units = "in", dpi = 600)
# PNAS recommended max height: 54 picas / 9” / 22.5 cm. 
# Use one of the following widths: 
# 1 column wide (20.5 picas / 3.42” / 8.7 cm) 
# 1.5 columns wide (27 picas / 4.5” / 11.4 cm) 
# 2 columns wide (42.125 picas / 7” / 17.8 cm)

```



## Tree survival models - tree level
156 trees, 32 plots

```{r Bayesian model, eval=FALSE}
## Chris guided me through setting up a few Bayesian models to overcome the singular fits and optimization issues with lme4::glmer

# Bayesian model to check drought and invasion effects
# library(rstanarm)

options(mc.cores = parallel::detectCores())

surv1 <- rstanarm::stan_glmer(survival ~ veg_trt*water_trt + (1|Plot), 
                              data = dat25cm,
                              family = binomial(link = "logit"))
print(surv1, digits = 3)
s1_r2 <- rstanarm::bayes_R2(surv1)
print(median(s1_r2))# 0.24
plot(surv1)

## Using this method we were able to "recover" the effect of the treatments that are easily seen in the summary figures in the model results.

```

Present results from models of tree survival using only tree height and flame height, or include maximum temperature?


### Model Results: scaled coefficients

Coefficients were scaled by subtracting the mean and dividing by two standard deviations (Gelman).

```{r tree survival scaled coefficients model}

library(lme4)
library(sjPlot)

# "scale" variables = subtract mean & divide by 1 SD
# "scl" variables = subtract mean & divide by 2 SD

# surv_veg_wtr <- glmer(survival ~ veg_trt*water_trt + (1|Plot),
#                               data = dat25cm,
#                               family = binomial(link = "logit"))
# summary(surv_veg_wtr)
# convergence code: 0
# unable to evaluate scaled gradient
# Model failed to converge: degenerate  Hessian with 1 negative eigenvalues
## Problem from interaction term

## Model using scaled variables
surv_scl <- glmer(
  survival ~ treeht_scale + flameht_scale + maxt_scale + sabv100_scale + (1|Plot), 
  family = binomial(link = logit), data = dat25cm)
summary(surv_scl)
MuMIn::r.squaredGLMM(surv_scl)# indicates limited variation from random effect

plot_model(surv_scl, show.values = T, colors = "bw") + 
  theme_classic() +
  geom_hline(yintercept = 1, color = "grey50")

plot_model(surv_scl, type = "pred", pred.type = "re", show.data = T)

surv_scl_no_temp <- glmer(
  survival ~ treeht_scale + flameht_scale + (1|Plot), 
  family = binomial(link = logit), data = dat25cm)
summary(surv_scl_no_temp)

plot_model(surv_scl_no_temp, show.values = T, colors = "bw") + 
  theme_classic() +
  geom_hline(yintercept = 1, color = "grey50")


broom::tidy(surv_scl) %>% 
  filter(group!="Plot") %>% 
  knitr::kable()

surv_scl_coef <- plot_model(surv_scl, show.values = T, colors = "bw",
                            value.size = 6)
surv_scl_coef$data$term <- c("Tree ht", "Flame ht", "Max temp", "s >100 ºC")

(surv_scl_mod_coef <- surv_scl_coef +
  theme_classic() +
  geom_hline(yintercept = 1, color = "grey80", linetype = "dashed") +
  ggtitle("") +
  def_theme +
  theme(axis.text = element_text(color = "black", size = 20),
        axis.title = element_text(size = 30)
        )
)

ggsave("figures/surv_scaled_coef_plot.pdf", width = 7.5, height = 7.5, dpi = 600)
# plot_model(surv_scl_no_temp, type = "pred", pred.type = "re", show.data = T)

```

```{r Bayesian models scaled predictors, eval=FALSE}

m1 <- rstanarm::stan_glmer(survival ~ tree_ht_scl + flame_ht_scl + max_temp_scl + (1 | Plot), data = dat25cm, family = binomial(link = "logit"), 
                           prior = rstanarm::student_t(4,0,2.5)
                           )
print(m1, digits = 3)
plot(m1)
m1_rsq <- rstanarm::bayes_R2(m1)
print(median(m1_rsq))# 0.58

m2 <- rstanarm::stan_glmer(survival ~ tree_ht_scl + flame_ht_scl + max_temp_scl + veg_trt + (1 | Plot), data = dat25cm, family = binomial(link = "logit"), prior = rstanarm::student_t(4,0,2.5))
print(m2, digits = 3)
plot(m2)
m2_rsq <- rstanarm::bayes_R2(m2)
print(median(m2_rsq))# 0.57

## Test temperatures recorded at 50 cm height
# m50cm1 <- glmer(
#   survival ~ tree_ht_scl + flame_ht_scl + max_temp_scl + (1|Plot), 
#   family = binomial(link = logit), data = dat50cm)
# summary(m50cm1)
# MuMIn::r.squaredGLMM(m50cm1)# 50cm nor random effect improves R2

```

The plotted model predictions are conditional on the plot-level random effect, i.e., the 95% confidence interval includes the uncertainty due to the unaccounted for variation between plots (assumed to be random variation).

### Model Results: Unscaled without temperature

```{r tree survival unscaled no temp}

surv_unscl <- glmer(
  survival ~ ht2_cm + avg_flameht_cm + (1|Plot), 
  family = binomial(link = "logit"), data = dat25cm)
summary(surv_unscl)

no_temp_model_coef <- plot_model(surv_unscl, show.values = TRUE, colors = "bw",
                                 value.size = 6)
no_temp_model_coef$data$term <- c("Tree ht", "Flame ht")

(no_temp_model_coef <- no_temp_model_coef +
  ylim(c(0.75,1.25)) +
  theme_classic() +
  geom_hline(yintercept = 1, color = "grey80", linetype = "dashed") +
  ggtitle("Unscaled") +
  def_theme +
  NULL
)

no_temp_model_pred <- plot_model(surv_unscl, type = "pred", pred.type = "re", show.data = FALSE)

(no_temp_ht_pred <- no_temp_model_pred$ht2_cm +
    geom_point(data = dat25cm, aes(x=ht2_cm, y=survival, color = veg_trt, shape = water_trt), size = 2) +
    invasion_color +
    scale_shape_discrete(solid = FALSE) +
  xlab("Tree height (cm)") +
  ylab("Survival probability") +
  ggtitle("") +
  theme_classic() +
  def_theme +
  NULL
)

(no_temp_fh_pred <- no_temp_model_pred$avg_flameht_cm +
    geom_point(data = dat25cm, aes(x=ht2_cm, y=survival, color = veg_trt, shape = water_trt), size = 4) +
    invasion_color +
    scale_shape_discrete(solid = FALSE) +
  # scale_x_continuous(limits = c(NA, 450)) +
  xlab("Flame height (cm)") +
  ylab("Survival probability") +
  ggtitle("") +
  theme_classic() +
  def_theme +
  theme(
    legend.position = c(400, 1),
        legend.margin = margin(-5,-1,-5,-1)) +
  NULL
)

```

```{r model results no temp}

broom::tidy(surv_unscl) %>% 
  knitr::kable(., caption = "Unscaled model coefficients")

cowplot::plot_grid(
  no_temp_ht_pred,
  no_temp_fh_pred +
    ylab(" "),
  no_temp_model_coef +
    theme(plot.title = element_text(size = 14, hjust = .5)),
  surv_scl_mod_coef +
    theme(axis.text.y = element_blank(),
          plot.title = element_text(size = 14, hjust = .5)),
  labels = "AUTO"
)

ggsave("figures/surv_model_600dpi.png",
       height = 12, width = 12, units = "in", dpi = 600)
# PNAS recommended max height: 54 picas / 9” / 22.5 cm. 
# Use one of the following widths: 
# 1 column wide (20.5 picas / 3.42” / 8.7 cm) 
# 1.5 columns wide (27 picas / 4.5” / 11.4 cm) 
# 2 columns wide (42.125 picas / 7” / 17.8 cm)

broom::tidy(surv_scl_no_temp) %>% 
  knitr::kable(., caption = "Scaled model coefficients")

```


### Model Results: Unscaled with temperature

```{r tree survival unscaled w temp}

## Model using unscaled predictor variables, including max temp
surv_unscl_2 <- glmer(
  survival ~ ht2_cm + avg_flameht_cm + avg_max_temp + avg_s_abv_100 + (1|Plot), 
  family = binomial(link = "logit"), data = dat25cm)
summary(surv_unscl_2)
MuMIn::r.squaredGLMM(surv_unscl_2)

temp_model_coef <- plot_model(surv_unscl_2, show.values = T, colors = "bw")
temp_model_coef$data$term <- c("Tree ht", "Flame ht", "Max temp", "s >100 ºC") 

(temp_model_coef <- temp_model_coef +
  ylim(c(0.75,1.25)) +
  theme_classic() +
  geom_hline(yintercept = 1, color = "grey80", linetype = "dashed") +
  ggtitle("") +
  def_theme +
  NULL
)

(surv_mod_ht_pred <- plot_model(surv_unscl_2, type = "pred", pred.type = "fe", show.data = F, terms = "ht2_cm") +
  
  geom_point(data = dat25cm, aes(x=ht2_cm, y=survival, color = veg_trt, shape = water_trt), size = 4) +
  
  scale_shape_discrete(solid = FALSE) +
  
  invasion_color +
  invasion_fill +
  ylab("Survival probability") +
  xlab("Tree height (cm)") +
  ggtitle("") +
  theme_classic() +
  def_theme +
  theme(legend.position = "none",
        axis.text = element_text(color = "black", size = 24),
        axis.title = element_text(size = 30)) +
  NULL
)
ggsave("figures/surv_treeht_pred.png", width = 7.5, height = 7.5, dpi = 600)

(surv_mod_fh_pred <- plot_model(surv_unscl_2, type = "pred", pred.type = "re", show.data = F, terms = "avg_flameht_cm") +
    geom_point(data = dat25cm, aes(x=avg_flameht_cm, y=survival, color = veg_trt, shape = water_trt), size = 4, 
               position = position_jitterdodge(jitter.width = 5)) +
  
  scale_shape_discrete(solid = FALSE) +
  # scale_x_continuous(limits = c(NA, 450)) +

  invasion_color +
  # invasion_fill +
  ylab("Survival probability") +
  xlab("Flame height (cm)") +
  ggtitle("") +
  theme_classic() +
  def_theme +
  theme(
    legend.position = "none",
    legend.margin = margin(-5,-1,-5,-1),
    axis.text = element_text(color = "black", size = 24),
    axis.title = element_text(size = 30)) +
  NULL
)
ggsave("figures/surv_flameht_pred.png", width = 7.5, height = 7.5, dpi = 600)

(surv_mod_temp_pred <- plot_model(surv_unscl_2, type = "pred", pred.type = "re", show.data = T, terms = "avg_max_temp") +
  invasion_color +
  invasion_fill +
  ylab("Survival probability") +
  xlab("Maximum temperature (ºC)") +
  ggtitle("") +
  theme_classic() +
  def_theme +
  NULL
)

```


```{r tree survival max temp results plot}

cowplot::plot_grid(
  surv_mod_ht_pred,
  surv_mod_fh_pred + ylab(" "),
  surv_scl_mod_coef,
  nrow = 1, labels = "AUTO", label_size = 25, 
)

ggsave("figures/surv_pred_coefs.png", width = 24, height = 7, dpi = 600)


```

Model results show that trees were more likely to survive fires if they were taller and if flame heights were lower. Furthermore, temperature measurements (maximum or duration) did not provide additional explanation of tree survival probability. 

INTERPRETATION: We assessed survival by examining for top kill, i.e. all the buds on all the branches and meristem were completely burned (no green left). Our estimates of maximum temperature at the plot-level were all greater than 100 ºC and the minimum time temperatures exceeded 100 ºC was 18.5 s. These minimum values are likely sufficient to kill buds on longleaf pines *if* the flames reach the buds; whether the maximum temperatures are much higher or temperature residence time is much longer appears to be less relevant. Essentially, if the flames generated were tall enough to reach the top or over the top of trees then the temperature and residence time were sufficiently long to result in top-kill. 


## Supplemental Information

```{r tree ht dbh}

library(ggpmisc)

summary(lm(ht2_cm ~ dbh_cm, data = tree_survival))
summary(lm(ht2_cm ~ diam1_mm, data = tree_survival))

ggplot(tree_survival, aes(diam2_mm, ht2_cm)) +
  geom_point() +
  geom_smooth(method = "lm")
  # stat_poly_eq(formula = form, parse = TRUE)

```
